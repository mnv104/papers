RUBBER=rubber -Wrefs -Wmisc

pdf: paper.pdf
.PHONY: pdf

paper.pdf: figures/vmware-it-vdi-bar2.pdf figures/vmware-it-vdi-cdf.pdf figures/copied-vs-dedup.pdf
	./lint
	$(RUBBER) --pdf -Wrefs -Wmisc paper.tex
.PHONY: paper.pdf

html: html/dede.html
.PHONY: html

html/dede.html: paper.pdf
	mkdir -p `dirname $@`
#	HeVeA looks for \jobname.bbl, but jobname=html/dede
	cp paper.bbl html/dede.bbl
#	Run HeVeA once to produce images file
	hevea -I hevea hacks.hva -e util-macros.tex -e paper.aux -o $@ paper.tex
#	Generate required images
	python hevea/hvaimages.py html/dede.image.tex
#	Run HeVeA to a fixed point to produce the final output
	hevea -fix -I hevea hacks.hva -e util-macros.tex -e paper.aux -o $@ paper.tex

html.tar.gz: html/dede.html
	tar czf $@ $^ html/dede*.png

clean:
	$(RUBBER) --pdf --clean paper.tex
	rm -f figures/vmware-it-vdi-cdf.pdf figures/copied-vs-dedup.pdf
.PHONY: clean

auto-aclements.bib auto-strings.bib:
	wget -O /tmp/readings.bib http://awk.csail.mit.edu/svn/amthrax/doc/readings/readings.bib
	(echo '@comment{{Generated by makefile}}'; echo; \
		grep '^@string' /tmp/readings.bib) > auto-strings.bib
	bib2bib -c 'keywords:"dedup" or $$type="PROCEEDINGS" or $$key:"fagin79.*"' /tmp/readings.bib > /tmp/aclements.bib
	grep -v '^@string' /tmp/aclements.bib | sed -e 's/^ *pages/xpages/' > auto-aclements.bib
.PHONY: auto-aclements.bib auto-strings.bib

figures/vmware-it-vdi-bar2.pdf: figures/vmware-it-vdi-bar2.py

figures/vmware-it-vdi-cdf.pdf: figures/vmware-it-vdi-cdf.gnuplot

figures/copied-vs-dedup.pdf: figures/copied-vs-dedup.gnuplot

%.pdf: %.gnuplot
	gnuplot $<

%.pdf: %.py
	python $< $@
